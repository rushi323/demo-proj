name: Terraform Multi-Env with KinD + Terraform + Helm (Env Values via GitHub Secrets)

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches:
      - "*"   # run on any branch push for demo

permissions:
  contents: read
  packages: write

jobs:
  validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3

      - name: Terraform Init (no backend)
        run: terraform -chdir=terraform init -backend=false

      - name: Terraform Validate
        run: terraform -chdir=terraform validate

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v3

      - name: Run TFLint
        run: tflint --chdir=terraform

  security:
    name: IaC Security (Checkov)
    runs-on: ubuntu-latest
    needs: [validate]
    steps:
      - uses: actions/checkout@v4
      - name: Run Checkov
        run: |
          pip install --quiet checkov
          checkov -d terraform

  build_image:
    name: Build & Push Image to GHCR
    runs-on: ubuntu-latest
    needs: [security]
    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push (GHCR)
        run: |
          docker build -t ghcr.io/${{ github.repository }}/myapp:latest ./helm/myapp
          docker push ghcr.io/${{ github.repository }}/myapp:latest

      - name: Trivy Scan (report only)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository }}/myapp:latest
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          exit-code: 0

  deploy_dev:
    name: Deploy to Dev (KinD + Terraform + Helm)
    runs-on: ubuntu-latest
    needs: [build_image]
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - uses: azure/setup-helm@v4

      - name: Install KinD
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind && sudo mv ./kind /usr/local/bin/kind
          kind create cluster --name demo
          kubectl cluster-info

      - name: Terraform Init (Dev)
        run: terraform -chdir=terraform init

      - name: Terraform Apply (Dev)
        run: terraform -chdir=terraform apply -auto-approve

      - name: Create Helm values (Dev) from GitHub Secrets
        run: |
          cat > helm/myapp/values-dev.ci.yaml <<'YAML'
          replicaCount: 1
          image:
            repository: ghcr.io/${{ github.repository }}/myapp
            tag: latest
          service:
            type: NodePort
            port: 80
          env:
            DB_USER: "${{ secrets.DEV_DB_USER }}"
            DB_PASS: "${{ secrets.DEV_DB_PASS }}"
          YAML

      - name: Helm Deploy (Dev)
        run: |
          helm upgrade --install myapp ./helm/myapp \
            --namespace demo-namespace --create-namespace \
            -f helm/myapp/values-dev.ci.yaml

      - name: Curl Service (Dev)
        run: |
          kubectl port-forward svc/myapp 8080:80 -n demo-namespace &
          sleep 4
          curl -I http://localhost:8080 || true

      - name: Cleanup KinD
        if: always()
        run: kind delete cluster --name demo

  deploy_staging:
    name: Deploy to Staging (KinD + Terraform + Helm)
    runs-on: ubuntu-latest
    needs: [deploy_dev]
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - uses: azure/setup-helm@v4

      - name: Install KinD
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind && sudo mv ./kind /usr/local/bin/kind
          kind create cluster --name demo
          kubectl cluster-info

      - name: Terraform Init (Staging)
        run: terraform -chdir=terraform init

      - name: Terraform Apply (Staging)
        run: terraform -chdir=terraform apply -auto-approve

      - name: Create Helm values (Staging) from GitHub Secrets
        run: |
          cat > helm/myapp/values-staging.ci.yaml <<'YAML'
          replicaCount: 2
          image:
            repository: ghcr.io/${{ github.repository }}/myapp
            tag: latest
          service:
            type: NodePort
            port: 80
          env:
            DB_USER: "${{ secrets.STAGING_DB_USER }}"
            DB_PASS: "${{ secrets.STAGING_DB_PASS }}"
          YAML

      - name: Helm Deploy (Staging)
        run: |
          helm upgrade --install myapp ./helm/myapp \
            --namespace demo-namespace --create-namespace \
            -f helm/myapp/values-staging.ci.yaml

      - name: Curl Service (Staging)
        run: |
          kubectl port-forward svc/myapp 8080:80 -n demo-namespace &
          sleep 4
          curl -I http://localhost:8080 || true

      - name: Cleanup KinD
        if: always()
        run: kind delete cluster --name demo

  deploy_prod:
    name: Deploy to Prod (KinD + Terraform + Helm)
    runs-on: ubuntu-latest
    needs: [deploy_staging]
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - uses: azure/setup-helm@v4

      - name: Install KinD
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind && sudo mv ./kind /usr/local/bin/kind
          kind create cluster --name demo
          kubectl cluster-info

      - name: Terraform Init (Prod)
        run: terraform -chdir=terraform init

      - name: Terraform Apply (Prod)
        run: terraform -chdir=terraform apply -auto-approve

      - name: Create Helm values (Prod) from GitHub Secrets
        run: |
          cat > helm/myapp/values-prod.ci.yaml <<'YAML'
          replicaCount: 3
          image:
            repository: ghcr.io/${{ github.repository }}/myapp
            tag: latest
          service:
            type: LoadBalancer
            port: 80
          env:
            DB_USER: "${{ secrets.PROD_DB_USER }}"
            DB_PASS: "${{ secrets.PROD_DB_PASS }}"
          YAML

      - name: Helm Deploy (Prod)
        run: |
          helm upgrade --install myapp ./helm/myapp \
            --namespace demo-namespace --create-namespace \
            -f helm/myapp/values-prod.ci.yaml

      - name: Curl Service (Prod)
        run: |
          kubectl port-forward svc/myapp 8080:80 -n demo-namespace &
          sleep 4
          curl -I http://localhost:8080 || true

      - name: Cleanup KinD
        if: always()
        run: kind delete cluster --name demo
